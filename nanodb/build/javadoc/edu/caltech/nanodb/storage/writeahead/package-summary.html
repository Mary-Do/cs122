<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<!-- NewPage -->
<html lang="en">
<head>
<!-- Generated by javadoc (1.8.0_111) on Wed Jan 18 13:25:15 PST 2017 -->
<title>edu.caltech.nanodb.storage.writeahead (NanoDB)</title>
<meta name="date" content="2017-01-18">
<link rel="stylesheet" type="text/css" href="../../../../../stylesheet.css" title="Style">
<script type="text/javascript" src="../../../../../script.js"></script>
</head>
<body>
<script type="text/javascript"><!--
    try {
        if (location.href.indexOf('is-external=true') == -1) {
            parent.document.title="edu.caltech.nanodb.storage.writeahead (NanoDB)";
        }
    }
    catch(err) {
    }
//-->
</script>
<noscript>
<div>JavaScript is disabled on your browser.</div>
</noscript>
<!-- ========= START OF TOP NAVBAR ======= -->
<div class="topNav"><a name="navbar.top">
<!--   -->
</a>
<div class="skipNav"><a href="#skip.navbar.top" title="Skip navigation links">Skip navigation links</a></div>
<a name="navbar.top.firstrow">
<!--   -->
</a>
<ul class="navList" title="Navigation">
<li><a href="../../../../../overview-summary.html">Overview</a></li>
<li class="navBarCell1Rev">Package</li>
<li>Class</li>
<li><a href="package-tree.html">Tree</a></li>
<li><a href="../../../../../deprecated-list.html">Deprecated</a></li>
<li><a href="../../../../../index-all.html">Index</a></li>
<li><a href="../../../../../help-doc.html">Help</a></li>
</ul>
</div>
<div class="subNav">
<ul class="navList">
<li><a href="../../../../../edu/caltech/nanodb/storage/heapfile/package-summary.html">Prev&nbsp;Package</a></li>
<li><a href="../../../../../edu/caltech/nanodb/transactions/package-summary.html">Next&nbsp;Package</a></li>
</ul>
<ul class="navList">
<li><a href="../../../../../index.html?edu/caltech/nanodb/storage/writeahead/package-summary.html" target="_top">Frames</a></li>
<li><a href="package-summary.html" target="_top">No&nbsp;Frames</a></li>
</ul>
<ul class="navList" id="allclasses_navbar_top">
<li><a href="../../../../../allclasses-noframe.html">All&nbsp;Classes</a></li>
</ul>
<div>
<script type="text/javascript"><!--
  allClassesLink = document.getElementById("allclasses_navbar_top");
  if(window==top) {
    allClassesLink.style.display = "block";
  }
  else {
    allClassesLink.style.display = "none";
  }
  //-->
</script>
</div>
<a name="skip.navbar.top">
<!--   -->
</a></div>
<!-- ========= END OF TOP NAVBAR ========= -->
<div class="header">
<h1 title="Package" class="title">Package&nbsp;edu.caltech.nanodb.storage.writeahead</h1>
<div class="docSummary">
<div class="block">
This package contains the implementation for the write-ahead log, which allows
us to provide transaction atomicity, consistency and durability.</div>
</div>
<p>See:&nbsp;<a href="#package.description">Description</a></p>
</div>
<div class="contentContainer">
<ul class="blockList">
<li class="blockList">
<table class="typeSummary" border="0" cellpadding="3" cellspacing="0" summary="Class Summary table, listing classes, and an explanation">
<caption><span>Class Summary</span><span class="tabEnd">&nbsp;</span></caption>
<tr>
<th class="colFirst" scope="col">Class</th>
<th class="colLast" scope="col">Description</th>
</tr>
<tbody>
<tr class="altColor">
<td class="colFirst"><a href="../../../../../edu/caltech/nanodb/storage/writeahead/LogSequenceNumber.html" title="class in edu.caltech.nanodb.storage.writeahead">LogSequenceNumber</a></td>
<td class="colLast">
<div class="block">This class represents a Log Sequence Number (LSN) in the write-ahead log.</div>
</td>
</tr>
<tr class="rowColor">
<td class="colFirst"><a href="../../../../../edu/caltech/nanodb/storage/writeahead/RecoveryInfo.html" title="class in edu.caltech.nanodb.storage.writeahead">RecoveryInfo</a></td>
<td class="colLast">
<div class="block">This class holds information necessary for the <a href="../../../../../edu/caltech/nanodb/storage/writeahead/WALManager.html" title="class in edu.caltech.nanodb.storage.writeahead"><code>WALManager</code></a> to perform
 recovery processing, such as the LSNs to scan for redo/undo processing, and
 the set of incomplete transactions.</div>
</td>
</tr>
<tr class="altColor">
<td class="colFirst"><a href="../../../../../edu/caltech/nanodb/storage/writeahead/WALManager.html" title="class in edu.caltech.nanodb.storage.writeahead">WALManager</a></td>
<td class="colLast">
<div class="block">
 This class manages the write-ahead logs of the database.</div>
</td>
</tr>
</tbody>
</table>
</li>
<li class="blockList">
<table class="typeSummary" border="0" cellpadding="3" cellspacing="0" summary="Enum Summary table, listing enums, and an explanation">
<caption><span>Enum Summary</span><span class="tabEnd">&nbsp;</span></caption>
<tr>
<th class="colFirst" scope="col">Enum</th>
<th class="colLast" scope="col">Description</th>
</tr>
<tbody>
<tr class="altColor">
<td class="colFirst"><a href="../../../../../edu/caltech/nanodb/storage/writeahead/WALRecordType.html" title="enum in edu.caltech.nanodb.storage.writeahead">WALRecordType</a></td>
<td class="colLast">
<div class="block">This enumeration specifies the various types of records that can appear in
 the write-ahead log, along with their numeric values that actually appear
 within the write-ahead log.</div>
</td>
</tr>
</tbody>
</table>
</li>
<li class="blockList">
<table class="typeSummary" border="0" cellpadding="3" cellspacing="0" summary="Exception Summary table, listing exceptions, and an explanation">
<caption><span>Exception Summary</span><span class="tabEnd">&nbsp;</span></caption>
<tr>
<th class="colFirst" scope="col">Exception</th>
<th class="colLast" scope="col">Description</th>
</tr>
<tbody>
<tr class="altColor">
<td class="colFirst"><a href="../../../../../edu/caltech/nanodb/storage/writeahead/WALFileException.html" title="class in edu.caltech.nanodb.storage.writeahead">WALFileException</a></td>
<td class="colLast">
<div class="block">This exception class represents issues with write-ahead log files, when they
 contain corrupt or invalid information in some way.</div>
</td>
</tr>
</tbody>
</table>
</li>
</ul>
<a name="package.description">
<!--   -->
</a>
<h2 title="Package edu.caltech.nanodb.storage.writeahead Description">Package edu.caltech.nanodb.storage.writeahead Description</h2>
<div class="block"><p>
This package contains the implementation for the write-ahead log, which allows
us to provide transaction atomicity, consistency and durability.  The
write-ahead log format is designed with several goals in mind:
</p>

<ul>
    <li>Log records provide <a href="http://en.wikipedia.org/wiki/Algorithms_for_Recovery_and_Isolation_Exploiting_Semantics">ARIES</a>-like
        features:  the individual records corresponding to a given transaction
        are chained together via "previous LSN" values stored in each record,
        allowing fast rollback of transaction modifications.</li>
    <li>The entire log file can be efficiently traversed both forward and
        backward, which is necessary during recovery processing.</li>
</ul>

<p>
To implement all of these features, the log record format is somewhat complex.
The details are outlined below.
</p>

<p>
For records that store the Previous LSN value, the Previous LSN is stored as
a two-byte log file number (in the range [0..65535]), and then a four-byte
file-offset (signed integer), relative to the start of the file.
</p>

<p>
In the descriptions below, a "B" suffix means "bytes".  For example, "6B" means
six bytes, and "<em>S<sub>si</sub></em> B" means <em>S<sub>si</sub></em> bytes.
</p>

<dl>
    <dt>&lt;<i>T<sub>i</sub></i> start&gt; (6 bytes)</dt>
    <dd>
        Start-transaction records don't require a "previous LSN" value, because
        there is no previous LSN for the transaction.  Thus, the format is as
        follows:
        <table>
            <tr><th>Size</th><th>Description</th></tr>

            <tr><td>1B</td><td><a href="../../../../../edu/caltech/nanodb/storage/writeahead/WALRecordType.html#START_TXN"><code>WALRecordType.START_TXN</code></a></td></tr>
            <tr><td>4B</td><td>Transaction ID</td></tr>

            <tr><td>1B</td><td><a href="../../../../../edu/caltech/nanodb/storage/writeahead/WALRecordType.html#START_TXN"><code>WALRecordType.START_TXN</code></a></td></tr>
        </table>
    </dd>

    <dt>&lt;<i>T<sub>i</sub></i> update <i>P</i> &rarr; <i>P'</i> &gt;</dt>
    <dd>
        Update records store modifications to data pages.  We record changes on
        the page-level for a variety of reasons.  First, in some situations the
        old value or the new value is actually missing, e.g. in the cases of an
        insert or a delete.  Also, we don't want the WAL to be tied to specific
        data-file formats; we would like to use the WAL for logging index
        changes as well as table changes.  The format is as follows:
        <table>
            <tr><th>Size</th><th>Description</th></tr>

            <tr><td>1B</td><td><a href="../../../../../edu/caltech/nanodb/storage/writeahead/WALRecordType.html#UPDATE_PAGE"><code>WALRecordType.UPDATE_PAGE</code></a></td></tr>
            <tr><td>4B</td><td>Transaction ID</td></tr>
            <tr><td>6B</td><td>PrevLSN</td></tr>

            <tr><td>1-256B</td><td>Filename of the modified file, written as a <code>VARCHAR(255)</code>.
                This value can be read with a function like <a href="../../../../../edu/caltech/nanodb/storage/DBFileReader.html#readVarString255--"><code>DBFileReader.readVarString255()</code></a>.</td></tr>
            <tr><td>2B</td><td>Page number of modified page, written as an unsigned short</td></tr>

            <tr><td valign="top">?B</td>
               <td>Description of the old page <i>P</i>, and the new page <i>P'</i>.
                   The differences are stored as a series of <em>segments</em>, where
                   each segment is a range of bytes that is different between the old
                   and new versions of the page.  Each segment is described by a
                   starting index, a size, and then two sequences of bytes.
                 <ul>
                   <li>2B - number of segments <em>N<sub>s</sub></em> (unsigned short)</li>
                   <li>
                     <em>N<sub>s</sub></em> repetitions of:
                     <ul>
                       <li>2B - starting index of the segment in the page (unsigned short)</li>
                       <li>2B - size of the segment in bytes, <em>S<sub>si</sub></em> (unsigned short)</li>
                       <li><em>S<sub>si</sub></em> B - old version of the data (i.e. undo data)</li>
                       <li><em>S<sub>si</sub></em> B - new version of the data (i.e. redo data)</li>
                     </ul>
                   </li>
                 </ul>
               </td></tr>

            <tr><td>4B</td><td>File-offset of the start of this update record,
                relative to the start of the file.</td></tr>
            <tr><td>1B</td><td><a href="../../../../../edu/caltech/nanodb/storage/writeahead/WALRecordType.html#UPDATE_PAGE"><code>WALRecordType.UPDATE_PAGE</code></a></td></tr>
        </table>
    </dd>

    <dt>&lt;<i>T<sub>i</sub></i> update (redo-only) <i>P'</i> &gt;</dt>
    <dd>
        Redo-only update records are similar to standard update records, except
        that they contain no undo information.  The format is as follows:
        <table>
            <tr><th>Size</th><th>Description</th></tr>

            <tr><td>1B</td><td><a href="../../../../../edu/caltech/nanodb/storage/writeahead/WALRecordType.html#UPDATE_PAGE_REDO_ONLY"><code>WALRecordType.UPDATE_PAGE_REDO_ONLY</code></a></td></tr>
            <tr><td>4B</td><td>Transaction ID</td></tr>
            <tr><td>6B</td><td>PrevLSN</td></tr>

            <tr><td>1-256B</td><td>Filename of the modified file, written as a <code>VARCHAR(255)</code>.
                This value can be read with a function like <a href="../../../../../edu/caltech/nanodb/storage/DBFileReader.html#readVarString255--"><code>DBFileReader.readVarString255()</code></a>.</td></tr>
            <tr><td>2B</td><td>Page number of modified page, written as an unsigned short</td></tr>

            <tr><td valign="top">?B</td>
               <td>Description of the new page <i>P'</i>.  
                   The differences are stored as a series of <em>segments</em>, where 
                   each segment is a range of bytes that is different between the old
                   and new versions of the page.  Since this is a redo-only record, only
                   the new version of the data is stored.  Each segment is described by a 
                   starting index, a size, and then two sequences of bytes.
                 <ul>
                   <li>2B - number of segments <em>N<sub>s</sub></em> (unsigned short)</li>
                   <li>
                     <em>N<sub>s</sub></em> repetitions of:
                     <ul>
                       <li>2B - starting index of the segment in the page (unsigned short)</li>
                       <li>2B - size of the segment in bytes, <em>S<sub>si</sub></em> (unsigned short)</li>
                       <li><em>S<sub>si</sub></em> B - new version of the data (i.e. redo data)</li>
                     </ul>
                   </li>
                 </ul>
               </td></tr>

            <tr><td>4B</td><td>File-offset of the start of this update record,
                relative to the start of the file.</td></tr>
            <tr><td>1B</td><td><a href="../../../../../edu/caltech/nanodb/storage/writeahead/WALRecordType.html#UPDATE_PAGE_REDO_ONLY"><code>WALRecordType.UPDATE_PAGE_REDO_ONLY</code></a></td></tr>
        </table>
    </dd>

    <dt>&lt;<i>T<sub>i</sub></i> commit&gt;</dt>
    <dd>
        Commit records are 12 bytes:
        <table>
            <tr><th>Size</th><th>Description</th></tr>

            <tr><td>1B</td><td><a href="../../../../../edu/caltech/nanodb/storage/writeahead/WALRecordType.html#COMMIT_TXN"><code>WALRecordType.COMMIT_TXN</code></a></td></tr>
            <tr><td>4B</td><td>Transaction ID</td></tr>
            <tr><td>6B</td><td>PrevLSN</td></tr>

            <tr><td>1B</td><td><a href="../../../../../edu/caltech/nanodb/storage/writeahead/WALRecordType.html#COMMIT_TXN"><code>WALRecordType.COMMIT_TXN</code></a></td></tr>
        </table>
    </dd>

    <dt>&lt;<i>T<sub>i</sub></i> abort&gt;</dt>
    <dd>
        Abort records are 12 bytes:
        <table>
            <tr><th>Size</th><th>Description</th></tr>

            <tr><td>1B</td><td><a href="../../../../../edu/caltech/nanodb/storage/writeahead/WALRecordType.html#ABORT_TXN"><code>WALRecordType.ABORT_TXN</code></a></td></tr>
            <tr><td>4B</td><td>Transaction ID</td></tr>
            <tr><td>6B</td><td>PrevLSN</td></tr>

            <tr><td>1B</td><td><a href="../../../../../edu/caltech/nanodb/storage/writeahead/WALRecordType.html#ABORT_TXN"><code>WALRecordType.ABORT_TXN</code></a></td></tr>
        </table>
    </dd>

</dl></div>
</div>
<!-- ======= START OF BOTTOM NAVBAR ====== -->
<div class="bottomNav"><a name="navbar.bottom">
<!--   -->
</a>
<div class="skipNav"><a href="#skip.navbar.bottom" title="Skip navigation links">Skip navigation links</a></div>
<a name="navbar.bottom.firstrow">
<!--   -->
</a>
<ul class="navList" title="Navigation">
<li><a href="../../../../../overview-summary.html">Overview</a></li>
<li class="navBarCell1Rev">Package</li>
<li>Class</li>
<li><a href="package-tree.html">Tree</a></li>
<li><a href="../../../../../deprecated-list.html">Deprecated</a></li>
<li><a href="../../../../../index-all.html">Index</a></li>
<li><a href="../../../../../help-doc.html">Help</a></li>
</ul>
</div>
<div class="subNav">
<ul class="navList">
<li><a href="../../../../../edu/caltech/nanodb/storage/heapfile/package-summary.html">Prev&nbsp;Package</a></li>
<li><a href="../../../../../edu/caltech/nanodb/transactions/package-summary.html">Next&nbsp;Package</a></li>
</ul>
<ul class="navList">
<li><a href="../../../../../index.html?edu/caltech/nanodb/storage/writeahead/package-summary.html" target="_top">Frames</a></li>
<li><a href="package-summary.html" target="_top">No&nbsp;Frames</a></li>
</ul>
<ul class="navList" id="allclasses_navbar_bottom">
<li><a href="../../../../../allclasses-noframe.html">All&nbsp;Classes</a></li>
</ul>
<div>
<script type="text/javascript"><!--
  allClassesLink = document.getElementById("allclasses_navbar_bottom");
  if(window==top) {
    allClassesLink.style.display = "block";
  }
  else {
    allClassesLink.style.display = "none";
  }
  //-->
</script>
</div>
<a name="skip.navbar.bottom">
<!--   -->
</a></div>
<!-- ======== END OF BOTTOM NAVBAR ======= -->
</body>
</html>
